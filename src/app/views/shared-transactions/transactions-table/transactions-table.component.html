<nb-card
  class="mt-0 shadow"
  [nbSpinner]="loadingTransactions"
  nbSpinnerStatus="danger"
  nbSpinnerSize="large"
  nbSpinnerMessage="Loading transactions"
>
  <nb-card-body>
    <div class="row mb-3">
      <div class="col-12">
        <div
          *ngIf="isAdminOrAgent"
          ngbDropdown
          class="d-inline-block mr-5 mb-xl-0 mb-3"
        >
          <button
            nbButton
            status="info"
            style="text-transform: none; border-radius: 13px"
            id="dropdownBasic1"
            ngbDropdownToggle
          >
            Change transaction type
          </button>
          <div ngbDropdownMenu aria-labelledby="dropdownBasic1">
            <button ngbDropdownItem (click)="make('transfer')">Transfer</button>
            <button ngbDropdownItem (click)="make('loan')">Loan</button>
            <button ngbDropdownItem (click)="make('trade')">Trade</button>
            <button ngbDropdownItem (click)="make('deposit')">Deposit</button>
            <button ngbDropdownItem (click)="make('withdraw')">Withdraw</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAKING A TRANSACTION SECTION -->
    <div
      class="row"
      *ngIf="makingTransaction && isAdminOrAgent"
      style="background-color: #f5f9ff; margin: 0rem -1rem"
    >
      <div class="col-12 py-3 px-lg-5 px-3">
        <div [ngSwitch]="transactionType">
          <div *ngSwitchCase="'transfer'">
            <app-transfer
              (onTransactionLock)="loadingTransactions = true"
              (onTransactionCreate)="rerenderTransactions($event)"
            ></app-transfer>
          </div>
          <div *ngSwitchCase="'trade'">
            <app-trade
              (onTransactionLock)="loadingTransactions = true"
              (onTransactionCreate)="rerenderTransactions($event)"
            ></app-trade>
          </div>
          <div *ngSwitchCase="'loan'">
            <app-loan
              (onTransactionLock)="loadingTransactions = true"
              (onTransactionCreate)="rerenderTransactions($event)"
            ></app-loan>
          </div>
          <div *ngSwitchCase="'withdraw'">
            <app-withdraw
              (onTransactionLock)="loadingTransactions = true"
              (onTransactionCreate)="rerenderTransactions($event)"
            ></app-withdraw>
          </div>
          <div *ngSwitchCase="'deposit'">
            <app-deposit
              (onTransactionLock)="loadingTransactions = true"
              (onTransactionCreate)="rerenderTransactions($event)"
            ></app-deposit>
          </div>
        </div>
      </div>
    </div>
    <!-- END MAKING A TRANSACTION -->

    <!-- <div class="row mt-3 mb-md-n5 mb-0">
      <div class="col-12 text-center align-items-center">
        <nb-select
          *ngIf="!isInStore"
          placeholder="Store"
          [formControl]="storeFormControl"
          filled
          shape="round"
          size="small"
          status="info"
          class="mr-4 mb-2"
          (selectedChange)="changedFilters()"
        >
          <nb-option value="all">Store</nb-option>
          <nb-option *ngFor="let store of stores" [value]="store._id">{{
            store.name
          }}</nb-option>
        </nb-select>
        <nb-select
          placeholder="Type"
          [formControl]="typeFormControl"
          filled
          shape="round"
          size="small"
          status="info"
          class="mr-4 mb-2"
          (selectedChange)="changedFilters()"
        >
          <nb-option value="all">Type</nb-option>
          <nb-option *ngFor="let type of transactionTypes" [value]="type._id">{{
            type.name
          }}</nb-option>
        </nb-select>
        <span
          *ngIf="hasFilters"
          style="
            text-decoration: underline;
            color: rgb(55, 102, 204);
            cursor: pointer;
          "
          (click)="resetFilters(true)"
          >Reset filters</span
        >
        <nb-icon
          nbSuffix
          icon="calendar-alt"
          status="info"
          class="mt-1"
          style="cursor: pointer; font-size: 1.4rem"
          (click)="dateInput.click()"
        ></nb-icon>
        <input
          #dateInput
          style="width: 0px; padding: 0; border: none"
          nbInput
          placeholder="Pick Date"
          [nbDatepicker]="rangepicker"
          [formControl]="periodFormControl"
        />
        <nb-rangepicker
          #rangepicker
          (rangeChange)="[periodFormControl.setValue($event), changedFilters()]"
          name="periodFormControl"
        ></nb-rangepicker>
      </div>
    </div> -->

    <div class="row pt-2">
      <div class="col-12">
        <table
          [dtTrigger]="$any(dtTrigger)"
          [dtOptions]="dtOptions"
          datatable
          class="table table-hover"
          width="100%"
        >
          <thead>
            <tr>
              <th width="20px">&nbsp;</th>
              <th>Date</th>
              <th>Amount In</th>
              <th>Amount Out</th>
              <th>Fee</th>
              <th>Payment type</th>
              <th>Direction</th>
              <th *ngIf="isAdminOrAgent && !isInClient">Client</th>
              <th *ngIf="isAdminOrAgent && !isInStore">Store</th>
              <th *ngIf="!isInClient">Created By</th>
              <th *ngIf="!isInClient">Description</th>
              <th>Status</th>
              <th width="20px">&nbsp;</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngFor="let transaction of tableTransactions"
              style="cursor: pointer"
              [ngClass]="{
                'row-issued': transaction.issue,
                'row-pending':
                  transaction.status === 'Open' && !transaction.issue,
                'row-closed':
                  transaction.status === 'Closed' && !transaction.issue
              }"
            >
              <td [attr.data-sort]="transaction.issue ? 'a' : 'b'">
                <nb-icon
                  icon="flag"
                  [status]="transaction.issue ? 'danger' : 'basic'"
                ></nb-icon>
              </td>
              <td
                class="text-capitalize"
                (click)="openEditTransaction(transactionDialog, transaction)"
                [attr.data-sort]="transaction.createdAt"
              >
                {{ transaction.createdAt | date: "medium" }}
              </td>
              <td [attr.data-sort]="transaction.amount_in">
                {{
                  transaction.amount_in | currency: transaction.currency?.symbol
                }}
              </td>
              <td [attr.data-sort]="transaction.amount_out">
                {{
                  transaction.amount_out
                    | currency: transaction.currency?.symbol
                }}
              </td>
              <td [attr.data-sort]="transaction.revenue">
                {{
                  transaction.revenue | currency: transaction.currency?.symbol
                }}
              </td>
              <td
                class="text-capitalize"
                (click)="openEditTransaction(transactionDialog, transaction)"
              >
                {{ transaction.type }}
              </td>
              <td
                class="text-capitalize"
                (click)="openEditTransaction(transactionDialog, transaction)"
              >
                {{ transaction.direction }}
              </td>

              <td
                *ngIf="isAdminOrAgent && !isInClient"
                class="text-capitalize"
                (click)="openEditTransaction(transactionDialog, transaction)"
              >
                {{ transaction.client?.name }} {{ transaction.client?.surname }}
              </td>
              <td
                *ngIf="isAdminOrAgent && !isInStore"
                class="text-capitalize"
                (click)="openEditTransaction(transactionDialog, transaction)"
              >
                {{ transaction.store?.name }}
              </td>

              <td
                *ngIf="!isInClient"
                class="text-capitalize"
                (click)="openEditTransaction(transactionDialog, transaction)"
              >
                {{ transaction.user?.name }}
              </td>
              <td
                *ngIf="!isInClient"
                style="
                  overflow: hidden;
                  white-space: nowrap;
                  text-overflow: ellipsis;
                  max-width: 150px;
                "
                class="text-ellipsis"
                (click)="openEditTransaction(transactionDialog, transaction)"
              >
                {{ transaction.description }}
              </td>
              <td
                class="text-capitalize"
                [ngClass]="{
                  'text-danger font-weight-bold': transaction.status === 'Open'
                }"
                (click)="openEditTransaction(transactionDialog, transaction)"
              >
                {{ transaction.status === "Open" ? "Pending" : "Completed" }}
                ({{ transaction.posts?.length }})
              </td>

              <td (click)="openEditTransaction(transactionDialog, transaction)">
                <nb-icon
                  icon="edit"
                  style="cursor: pointer"
                  status="basic"
                ></nb-icon>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </nb-card-body>
</nb-card>

<ng-template #transactionDialog let-ref="dialogRef">
  <nb-card
    [status]="
      transaction.status === 'Open'
        ? transaction.issue
          ? 'danger'
          : 'info'
        : 'success'
    "
    style="border: none"
  >
    <nb-card-header class="d-flex align-items-start justify-content-between">
      <span
        class="mr-4"
        style="
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 25ch;
        "
      >
        {{ transaction.description }}</span
      >
      <span class="">
        {{ transaction.status === "Open" ? "Pending" : "Completed" }}
      </span>
      <span class="mx-4">
        {{ transaction.createdAt | date: "mediumDate" }}
      </span>
      <span>
        <nb-icon
          icon="window-close"
          (click)="ref.close()"
          style="cursor: pointer"
        ></nb-icon>
      </span>
    </nb-card-header>
    <nb-card-body class="p-3">
      <div class="row mb-5 posts-row">
        <div class="col-12">
          <div class="row mb-2">
            <div class="col text-left">
              <p
                class="text-muted text-uppercase font-weight-bold"
                style="color: #959595"
              >
                Movements
              </p>
            </div>
            <div class="col text-right">
              <button
                *ngIf="transaction.type === 'trade'"
                nbButton
                status="warning"
                size="small"
              >
                Add sale
              </button>
            </div>
          </div>

          <table
            datatable
            [dtOptions]="dialogDtOptions"
            class="table table-hover table-sm mt-3"
            width="100%"
          >
            <thead>
              <tr>
                <th>detail</th>
                <th>date</th>
                <th>amount</th>
                <th>type</th>
                <th *ngIf="!isInClient">Created By</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let post of transaction?.posts">
                <td
                  class="post-first-td"
                  style="word-wrap: break-word; max-width: 150px"
                >
                  {{ post.details }}
                </td>
                <td>{{ post.date | date: "mediumDate" }}</td>
                <td>{{ post.ammount | currency: post.currency.symbol }}</td>
                <td class="text-capitalize">{{ post.type }}</td>
                <td *ngIf="!isInClient">{{ post.user?.name }}</td>
                <td (click)="openEditPost(postContent, post)">
                  <nb-icon
                    icon="edit"
                    status="basic"
                    style="cursor: pointer"
                  ></nb-icon>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-6">
          <div class="row">
            <div class="col-12">
              <p
                class="mb-2 text-muted text-uppercase font-weight-bold"
                style="color: #959595"
              >
                Transaction details
              </p>
            </div>
          </div>

          <div
            class="p-2"
            style="
              background-color: #f5f9ff;
              min-height: 100px;
              border-radius: 6px;
            "
          >
            <div class="d-flex align-items-center justify-content-between mb-2">
              <strong class="mr-2 text-muted font-smaller">Created At</strong>
              <span>{{ transaction.createdAt | date: "mediumDate" }}</span>
            </div>
            <div
              *ngIf="isAdminOrAgent"
              class="d-flex align-items-center justify-content-between mb-2"
            >
              <strong class="mr-2 text-muted">Store</strong>
              <span>{{ transaction.store?.name || "-" }}</span>
            </div>
            <div
              *ngIf="isAdminOrAgent"
              class="d-flex align-items-center justify-content-between mb-2"
            >
              <strong class="mr-2 text-muted">Client</strong>
              <span
                >{{ transaction.client?.name || "-" }}
                {{ transaction.client?.surname }}</span
              >
            </div>
            <div class="d-flex align-items-center justify-content-between mb-2">
              <strong class="mr-2 text-muted">Payment type</strong>
              <span class="text-capitalize">{{ transaction.type }}</span>
            </div>
            <div class="d-flex align-items-center justify-content-between mb-2">
              <strong class="mr-2 text-muted">Direction</strong>
              <span class="text-capitalize">{{ transaction.direction }}</span>
            </div>
            <div
              *ngIf="!isInClient"
              class="d-flex align-items-center justify-content-between mb-2"
            >
              <strong class="mr-2 text-muted">Created By</strong>
              <span class="text-capitalize">{{
                transaction.user?.name || "-"
              }}</span>
            </div>
            <div
              *ngIf="!isInClient"
              class="d-flex align-items-center justify-content-between mb-2"
            >
              <strong class="mr-2 text-muted">Description</strong>
              <span>{{ transaction.description }}</span>
            </div>
            <div class="text-center">
              <button
                nbButton
                *ngIf="editingTransactionDetails && isAdmin"
                status="success"
                size="small"
              >
                Save
              </button>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <p
            class="mt-md-0 mt-5 mb-2 text-muted text-uppercase font-weight-bold"
            style="color: #959595"
          >
            Comments
          </p>

          <small *ngIf="transaction?.comments?.length === 0"
            >No comments have been added yet for this transaction</small
          >

          <div style="max-height: 200px; overflow: auto">
            <p
              class="mb-2 d-flex flex-column flex-wrap"
              style="font-size: 13.5px"
              *ngFor="let comment of transaction.comments"
              [ngClass]="{ 'text-danger': comment.issue === 'Open' }"
            >
              <span>
                <strong>{{ comment.user?.name || "Unknown" }}:</strong>
                {{ comment.comment }}
              </span>
              <span style="font-size: 12px" class="text-muted">
                {{ comment.createdAt | date: "MMM d, y, HH:mm" }}
              </span>
            </p>
          </div>

          <textarea
            nbInput
            fullWidth
            rows="2"
            [formControl]="commentFormControl"
            placeholder="Insert comment here"
            style="resize: none; margin-top: 10px"
          ></textarea>
          <div class="text-right">
            <button
              nbButton
              status="info"
              size="small"
              class="mr-sm-2"
              (click)="addComment('Closed')"
            >
              comment
            </button>
            <button
              nbButton
              status="danger"
              size="small"
              class="mt-sm-0"
              (click)="addComment('Open')"
            >
              comment + flag
            </button>
          </div>
        </div>
      </div>
    </nb-card-body>
  </nb-card>
</ng-template>

<ng-template #postContent let-ref="dialogRef">
  <nb-card>
    <nb-card-header class="d-flex align-items-start justify-content-between">
      <span> UPDATE MOVEMENT </span>
      <span>
        <nb-icon
          icon="window-close"
          (click)="ref.close()"
          style="cursor: pointer"
          status="basic"
        ></nb-icon>
      </span>
    </nb-card-header>
    <nb-card-body>
      <form [formGroup]="postForm" class="overflow-auto">
        <div class="form-group mb-2">
          <label class="label">Amount *</label>
          <input
            type="text"
            nbInput
            fullWidth
            [status]="p.amount.touched && p.amount.errors ? 'danger' : 'basic'"
            formControlName="amount"
            placeholder="Amount *"
          />
          <small
            *ngIf="p.amount.touched && p.amount.errors"
            class="form-text text-danger"
            >Please enter a valid amount.</small
          >
        </div>
        <div class="form-group mb-2">
          <label class="label">Amount *</label>
          <input
            type="text"
            [nbDatepicker]="datepicker"
            nbInput
            fullWidth
            [status]="p.date.touched && p.date.errors ? 'danger' : 'basic'"
            formControlName="date"
            placeholder="Date *"
          />
          <nb-datepicker #datepicker></nb-datepicker>

          <small
            *ngIf="p.date.touched && p.date.errors"
            class="form-text text-danger"
            >Please enter a valid date.</small
          >
        </div>
        <div class="form-group mb-2">
          <label class="label">Details *</label>
          <input
            type="text"
            nbInput
            fullWidth
            [status]="
              p.details.touched && p.details.errors ? 'danger' : 'basic'
            "
            formControlName="details"
            placeholder="Details *"
          />
          <small
            *ngIf="p.details.touched && p.details.errors"
            class="form-text text-danger"
            >Please enter a description.</small
          >
        </div>
      </form>
    </nb-card-body>
    <nb-card-footer>
      <button type="button" nbButton class="mr-3" (click)="ref.close()">
        Close
      </button>
      <button
        type="button"
        nbButton
        class=""
        status="success"
        (click)="updateMovement(ref)"
      >
        Save
      </button>
    </nb-card-footer>
  </nb-card>
</ng-template>
